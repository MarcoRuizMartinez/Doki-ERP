import {  Col                     } from "components/utilidades/AgGrid/ColumnasAG"
import {  ColDef,
          ColTypeDef,
          ColGroupDef             } from "ag-grid-community"
import {  getCategoriasDB,
          getNaturalezasDB,
          getUnidadesDB,
                                  } from "src/composables/useDexie"
import {  TiposProductos          } from "src/areas/productos/models/TipoProducto"
//import {  MesesGarantia           } from "src/models/Diccionarios/MesesGarantia"
//import {  OriginesMadeIn          } from "src/models/Diccionarios/MadeIn"
import {  Format,
          ToolType
                                  } from "src/composables/useTools"
import {  IProductoDoli           } from "../../models/ProductoDolibarr"
import imagen                       from "./../ImagenProductoAG.vue"
//import proveedor                    from "components/utilidades/AgGrid/ProveedorBadge.vue"

export const reglasCSS = {
/*   'bg-grey-10 text-grey-2 text-bold'  : ( params : any ) =>  !params.data,
  'bg-grey-3 text-grey-7'             : ( params : any ) =>  !!params.data && !params.data?.activo     && !params.data?.esNuevo,
  'text-deep-purple-3'                : ( params : any ) => { return !params.data?.disponible && !!params.data?.activo && !params.data?.esNuevo },
  'bg-green-2'                        : ( params : any ) => { return params.data?.esNuevo },
  'bg-amber-1'                        : ( params : any ) => { return params.data?.tipo?.esCompuesto || params.data?.tipo?.esHijo }, */
}

export const autoSizeStrategy = {
  type                  : 'fitCellContents', // fitProvidedWidth fitGridWidth
  defaultMinWidth       : 100,  
  columnLimits          : [{ colId: 'ref', minWidth: 900}]
}

export const columnTypes : { [key: string]: ColTypeDef< IProductoDoli > } = {
  moneda:
  { 
    valueFormatter  : Format.precioAG,
    cellClass       : "text-right fuente-mono",
  },
  porcentaje:
  { 
    valueFormatter  : p => p.value + "%",
    cellClass       : "text-right fuente-mono",
  },  
  numero:
  {
    cellClass       : "text-right",
  },
  editable:
  {
    /* editable: p => {
      if(!p.data) return false

      const columna         = p.colDef?.field ?? "" 
      const campoEspecial   = esFieldDeEditarHijo( columna ) 
      const hijoNoEspecial  = p.data.tipo.esHijo && !campoEspecial
      if(hijoNoEspecial)
        return false

      return p.data.editable
    } */
  },
  creacion:
  {
    /* editable: p => {
      if(!p.data) return false

      const columna         = p.colDef?.field ?? "" 
      const campoEspecial   = esFieldDeEditarHijo( columna ) 
      const hijoNoEspecial  = p.data.tipo.esHijo && !campoEspecial
      if(hijoNoEspecial)
        return false

      return ( p.data?.esNuevo ?? false )
    } */
  },
  editarYCrear:
  {
    editable: p => {
      if(!p.data) 
        return false

      const columna         = p.colDef?.field ?? "" 
      /* const campoEspecial   = esFieldDeEditarHijo( columna ) 
      const hijoNoEspecial  = p.data.tipo.esHijo && !campoEspecial
      if(hijoNoEspecial)
        return false */

      return  ( p.data?.esNuevo ?? false )  ||  p.data.editable
    }
  }     
}

/* function esFieldDeEditarHijo( field : string )
{
  return      field == "ref"
          ||  field == "nombre"
          ||  field == "urlImagen"
          ||  field == "activo"
          ||  field == "disponible"
          ||  field == "stock"
          ||  field == "fechaLlegada"
          ||  field == "refPadre"
          ||  field == "descripcion"
          ||  field == "orden"
          ||  field == "tipo"
          ||  field == "categoria"
          ||  field == "familia"
          ||  field == "costoExtra"
          ||  field == "garantiaMeses"
          ||  field == "stockGestionado"
} */

//const limpiarRef   = ( p : any ) => ToolType.keyStringValido(p, "newValue").replaceAll(" ", "").trim()


const claseColFn            = ( color : string, nivel : number ) => `bg-${color}-${nivel} text-white`
const claseCol              = ( color : string ) => { return { col: claseColFn( color, 6 ),  header: claseColFn( color, 10 )} }
const claseHDatos           = claseCol("light-blue")
const claseHDispo           = claseCol("purple")
const claseHRequi           = claseCol("brown")
const claseHPrecios         = claseCol("deep-orange")
const claseHCostos          = claseCol("indigo")
const claseHExtras          = claseCol("blue-grey")
const claseHRegistro        = claseCol("pink")

// * ////////////////////////////////////////////////////////////////////////////////////////////////// COLUMNAS
export function columnasProductos( conPrecios : boolean ) : ( ColDef< IProductoDoli >  | ColGroupDef )[] 
{
  // * //////////////////////////////////////////////////////////////////////////////// Imagen
  const columnas : (ColDef< IProductoDoli >  | ColGroupDef)[] = [
    {
      headerName            : "üñºÔ∏è",
      field                 : "img",
      headerClass           : claseColFn( "grey", 10 ),
      width                 : 80, 
      cellRenderer          : imagen,
      filter                : "agSetColumnFilter",
      valueFormatter        : ( p : any ) => p.value?.hayImagen ?? "",
      //cellClassRules        : { 'bg-deep-orange-2': ( p : any ) => ( p.data?.esNuevo ?? false ) && !p.data.sePuedeCrear }
    },
    // * //////////////////////////////////////////////////////////////////////////////// Datos basicos
    {
      headerName            : "üóÉÔ∏è Datos de producto",
      headerClass           : claseHDatos.header,
      marryChildren         : false,
      children              :
      [
        { headerName        : "üÜîRef",
          field             : "ref",
          headerClass       : claseHDatos.col,
          hide: false,
        },
        { headerName        : "üë§Nombre",
          field             : "nombre",
          headerClass       : claseHDatos.col,
          type              : "editarYCrear",
          minWidth          : 340,
          hide: true,
        },
        { headerName        : "üìùNota",
          field             : "nota",
          headerClass       : claseHDatos.col,          
          hide: true,
          type              : "editarYCrear",
        },
        { headerName        : "üìôDocumento",
          field             : "documento",
          headerClass       : claseHDatos.col,          
          hide: true,
          type              : "editarYCrear",
        },
        { headerName        : "üë®‚Äçüë©‚Äçüëß‚Äçüë¶Familia",
          field             : "familia",
          headerClass       : claseHDatos.col,          
          type              : "editarYCrear",
          hide: true,
          enableRowGroup    : true,
          valueParser       : p => ToolType.keyStringValido(p, "newValue").trim()          
        },                
        Col.Objeto(
          {
            headerName      : "üÜéCategor√≠a",
            field           : "categoria",
            headerClass     : claseHDatos.col,
            opciones        : getCategoriasDB,
            key             : "label",
            type            : "creacion",
            hide: true,
            cellClassRules  : { 'bg-deep-orange-2': p => ( p.data?.esNuevo ?? false ) && !p.data.okCategoria },
            noNulo          : true,
          }
        ),
        Col.Objeto(
          {
            headerName      : "üî¢Tipo",
            field           : "tipo",
            headerClass     : claseHDatos.col,
            opciones        : TiposProductos,
            key             : "label",
            type            : "editarYCrear",
            noNulo          : true,
            hide: false,
          } 
        ),
        Col.Objeto(
          {
            headerName      : "üå±Naturaleza",
            field           : "naturaleza",
            headerClass     : claseHDatos.col,
            opciones        : getNaturalezasDB,
            key             : "label",
            type            : "editarYCrear",
            minWidth        : 160,
            noNulo          : true,
            hide: true,
          }
        ),
        Col.Objeto(
          {
            headerName      : "üìêUnidad",
            field           : "unidad",
            headerClass     : claseHDatos.col,
            opciones        : getUnidadesDB,
            key             : "label",
            type            : "editarYCrear",
            noNulo          : true,
            hide: true,
          }
        ),
        { headerName        : "üìÑDescripci√≥n",
          field             : "descripcion",
          headerClass       : claseHDatos.col,
          minWidth          : 340,
          type              : "editarYCrear",
          hide: true,
        },
      ]
    },
  ]

  // * //////////////////////////////////////////////////////////////////////////////// Disponibilidad  
  columnas.push(
    {
      headerName            : "üì¶ Disponibilidad de producto",                      
      headerClass           : claseHDispo.header,
      marryChildren         : false,      
      children              :
      [
        Col.Boolean({
          headerName        : "‚úÖEn venta",
          field             : "activoEnVenta",
          headerClass       : claseHDispo.col,
          type              : "editarYCrear",
          minWidth          : 140,
          hide: true,
        }),
        Col.Boolean({
          headerName        : "‚úÖEn compra",
          field             : "activoEnCompra",
          headerClass       : claseHDispo.col,
          type              : "editarYCrear",
          minWidth          : 140,
          hide: true,
        }),
        Col.Boolean({
          headerName        : "‚õîSin proveedor",
          field             : "sin_proveedor",
          headerClass       : claseHDispo.col,
          type              : "editarYCrear",
          minWidth          : 170,
          editable          : false,
          hide: true,
        }),
        Col.Boolean({
          headerName        : "üì¶Stock gestionado",
          field             : "stockGestionado",
          headerClass       : claseHDispo.col,
          minWidth          : 180,
          editable          : false,
          hide: true,
        }),        
        Col.Boolean({
          headerName        : "üì¶Stock proveedor",
          field             : "stockProveedor",
          headerClass       : claseHDispo.col,
          type              : "editarYCrear",
          minWidth          : 180,
          editable          : false,
          hide: true,
        }),
      ]
    },
  )

  // * //////////////////////////////////////////////////////////////////////////////// Requerimientos
  columnas.push(
    {
      headerName            : "‚úîÔ∏è Requerimientos",                      
      headerClass           : claseHRequi.header,
      marryChildren         : false,
      children              :
      [
        Col.Boolean({
          headerName        : "‚úÖAcabado",
          field             : "requiereAcabado",
          headerClass       : claseHRequi.col,
          type              : "editarYCrear",
          minWidth          : 130,
          hide: true,
        }),
        Col.Boolean({
          headerName        : "‚úÖMedida",
          field             : "requiereMedida",
          headerClass       : claseHRequi.col,
          type              : "editarYCrear",
          minWidth          : 130,
          hide: true,
        }),
        Col.Boolean({
          headerName        : "‚úÖEntrega",
          field             : "requiereEntregado",
          headerClass       : claseHRequi.col,
          type              : "editarYCrear",
          minWidth          : 130,
          hide: true,
        }),
      ]
    },
  )
  

  // * //////////////////////////////////////////////////////////////////////////////// Precios
  columnas.push(
    {
      headerName            : "ü™ô Precios",                      
      headerClass           : claseHPrecios.header,
      marryChildren         : false,
      children              :
      [
        Col.Precio({
          headerName        : "ü™ôPrecio final",
          field             : "precio_final",
          headerClass       : claseHPrecios.col,
          hide: false,
        }),
        { headerName        : "üè¶IVA",
          field             : "iva",
          headerClass       : claseHPrecios.col,
          type              : "porcentaje",
          width             : 90,
          hide: true,
        },
        { headerName        : "‚ÜóÔ∏èBase",
          field             : "aumento",
          headerClass       : claseHPrecios.col,
          type              : ["porcentaje", "editarYCrear"],
          width             : 100,
          hide: false,
          valueParser       : reglaAumento
        },        
        Col.Precio({
          headerName        : "üí≤Base",
          field             : "precio_aumento",
          headerClass       : claseHPrecios.col,
          minWidth          : 100,
          hide: false,
        }),
        { headerName        : "‚ÜóÔ∏èDescuento",
          field             : "aumento_descuento",
          headerClass       : claseHPrecios.col,
          type              : ["porcentaje", "editarYCrear"],
          width             : 140,
          hide: false,
          valueParser       : reglaAumento,
        },
        Col.Precio({
          headerName        : "üí≤Descuento",
          field             : "precio_aumento_descuento",
          headerClass       : claseHPrecios.col,
          minWidth          : 140,
          hide: false,
        }),
        { headerName        : "‚ÜóÔ∏èEscom",
          field             : "aumento_escom",
          headerClass       : claseHPrecios.col,
          type              : ["porcentaje", "editarYCrear"],
          width             : 110,
          hide: false,
          valueParser       : reglaAumento
        },
        Col.Precio({
          headerName        : "üí≤Escom",
          field             : "precio_aumento_escom",
          headerClass       : claseHPrecios.col,
          minWidth          : 110,
          hide: true,
        }),
        /*
        { headerName        : "‚ÜóÔ∏èBlack Friday",
          field             : "aumento_loco",
          headerClass       : claseHAumentos.col,
          type              : ["porcentaje", "editarYCrear"],
          width             : 150,          
          hide: true,
        }, */
        /* Col.Precio({
          headerName        : "üí≤Black Friday",
          field             : "precio_aumento_loco",
          headerClass       : claseHAumentos.col,
          width             : 150,
          hide: true,
        }),
        */            
      ]
    },
  )


  // * //////////////////////////////////////////////////////////////////////////////// Costos
  columnas.push(
    {
      headerName            : "ü´∞üèª Costos",                      
      headerClass           : claseHCostos.header,
      marryChildren         : false,
      children              :
      [
        Col.Precio({
          headerName        : "üí≤Compra",
          field             : "costo",
          headerClass       : claseHCostos.col,
          type              : "editarYCrear",
          width             : 150,
          hide: false,
        }),
        Col.Precio({
          headerName        : "üí≤Costo extra",
          field             : "costoExtra",
          headerClass       : claseHCostos.col,
          type              : "editarYCrear",
          width             : 150,
          hide: false,
        }),
        Col.Precio({
          headerName        : "üí≤Costo total",
          field             : "costoTotal",
          headerClass       : claseHCostos.col,
          width             : 150,
          hide: false,
        }),        
      ]
    }
  )

  // * //////////////////////////////////////////////////////////////////////////////// Otros valores
  columnas.push(
    {
      headerName            : "üìãRegistro de cambios",
      headerClass           : claseHRegistro.header,
      marryChildren         : false,
      children              :
      [
        { headerName        : "üë§Creador",
          field             : "creador.label",  
          headerClass       : claseHRegistro.col,
          hide: true,
        },
        { headerName        : "üìÖFecha Creaci√≥n",
          field             : "fechaCreacion",  
          minWidth          : 170,
          headerClass       : claseHRegistro.col,
          hide: true,
        },
        { headerName        : "üë§Edito",
          field             : "edito.label",  
          headerClass       : claseHRegistro.col,
          hide: true,
        },
        { headerName        : "üìÖFecha Edici√≥n",
          field             : "fechaEdicion",  
          minWidth          : 170,
          headerClass       : claseHRegistro.col,
          hide: true,
        }
      ]
    }
  )

  // * //////////////////////////////////////////////////////////////////////////////// Otros valores
  columnas.push(
    {
      headerName            : "üìÇ Otros datos",                      
      headerClass           : claseHExtras.header,
      marryChildren         : false,
      children              :      
      [
        { headerName        : "Codigo Siigo",
          field             : "siigo.codigo",
          headerClass       : claseHExtras.col,
          width             : 130,
          cellClass         : "fuente-mono text e-right",
          hide: true, 
        },
      ]
    }
  )

  return columnas
}


/* 
function parserNumber( p : any )
{
  if( ToolType.keyStringValido(p, "newValue" ) === "" )
    return ToolType.keyNumberValido(p, "oldValue")
  else
    return ToolType.keyNumberValido(p, "newValue")
}
 */
function reglaAumento( p : any )
{
  let   aumento       = 0  
  const campo         = ToolType.keyStringValido( p.column, "colId" )

  if( ToolType.keyStringValido(p, "newValue" ) === "" )
    aumento           = ToolType.keyNumberValido(p, "oldValue")
  else
    aumento           = ToolType.keyNumberValido(p, "newValue")  

  if(campo            === "aumento_descuento")
  {
    const aumento2    = ToolType.keyNumberValido(p.data, "aumento")
    if( aumento       >= aumento2)
      aumento         = aumento2 - 1
  }
  else
  {
    const aumento2    = ToolType.keyNumberValido(p.data, "aumento_descuento")
    if( aumento       <= aumento2)
      aumento         = aumento2 + 1
  }

  return aumento
}